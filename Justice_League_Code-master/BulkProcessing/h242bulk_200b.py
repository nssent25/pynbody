import matplotlib as mpl
mpl.use('Agg')
import pynbody
import matplotlib.pyplot as plt
import numpy as np
import pynbody.plot as pp
import pynbody.filt as filt
import pickle
import pandas as pd
import logging
from pynbody import array,filt,units,config,transformation
from pynbody.analysis import halo
import os

# set the config to prioritize the AHF catalog
pynbody.config['halo-class-priority'] =  [pynbody.halo.ahf.AHFCatalogue,
                                          pynbody.halo.GrpCatalogue,
                                          pynbody.halo.AmigaGrpCatalogue,
                                          pynbody.halo.legacy.RockstarIntermediateCatalogue,
                                          pynbody.halo.rockstar.RockstarCatalogue,
                                          pynbody.halo.subfind.SubfindCatalogue, pynbody.halo.hop.HOPCatalogue]


from timescales_bulk import bulk_processing # import the bulk processing function

snapnums = ['004096', '004032', '003936', '003840', '003744', '003648', '003606', '003552', '003456', '003360', '003264', '003195', '003168', '003072','002976', '002880', '002784', '002688', '002592', '002554', '002496', '002400', '002304','002208', '002112', '002088', '002016', '001920', '001824','001740','001728','001632', '001536', '001475', '001440', '001344', '001269', '001248','001152', '001106', '001056', '000974', '000960','000864', '000776', '000768', '000672', '000637', '000576', '000480', '000456', '000384', '000347', '000288', '000275', '000225', '000192', '000188', '000139', '000107', '000096', '000071']

# haloids dictionary defines the major progenitor branch back through all snapshots for each z=0 halo we are 
# interest in ... read this as haloids[1] is the list containing the haloid of the major progenitors of halo 1
# so if we have three snapshots, snapshots = [4096, 2048, 1024] then we would have haloids[1] = [1, 2, 5] 
# --- i.e. in snapshot 2048 halo 1 was actually called halo 2, and in 1024 it was called halo 5

### the below haloids and rvirs are updated to match the z=0 haloids in the 200 bkgdens simulations
haloids = {
    1: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 4, 4, 4, 2],
    10: [10, 10, 9, 7, 7, 8, 7, 7, 7, 4, 5, 5, 5, 6, 6, 4, 3, 3, 3, 3, 3, 4, 5, 5, 6, 6, 4, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 6, 9, 9, 9, 10, 10, 9, 13, 14, 16, 18, 18, 18, 20],
    12: [12, 12, 12, 9, 10, 11, 10, 10, 10, 9, 10, 6, 6, 5, 4, 3, 4, 4, 4, 4, 4, 5, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 4, 4, 4, 4, 4, 5, 6, 6, 7, 8, 8, 8, 8, 10, 11, 10, 7, 6, 11, 11, 7, 11, 11, 9, 5, 6, 9],
    24: [24, 24, 25, 26, 25, 25, 25, 24, 24, 23, 24, 25, 24, 22, 22, 22, 21, 20, 19, 19, 19, 19, 19, 20, 19, 19, 17, 20, 21, 21, 20, 21, 17, 16, 17, 15, 15, 16, 15, 18, 17, 17, 17, 20, 21, 21, 20, 21, 24, 26, 28, 25, 24, 27, 29, 23, 20, 19, 14, 12, 16, 17],
    30: [30, 29, 29, 31, 29, 28, 29, 29, 30, 32, 30, 29, 28, 26, 25, 24, 22, 22, 20, 20, 20, 21, 21, 22, 21, 21, 18, 19, 18, 17, 16, 17, 15, 13, 14, 12, 13, 14, 13, 13, 13, 14, 14, 13, 15, 15, 14, 15, 16, 16, 17, 18, 16, 14, 12, 8, 9, 9, 8, 6, 5, 4],
    34: [34, 33, 34, 36, 35, 35, 34, 34, 35, 36, 33, 33, 33, 33, 33, 33, 33, 32, 32, 32, 32, 31, 31, 30, 30, 31, 28],
    40: [40, 40, 41, 44, 41, 41, 42, 41, 42, 42, 40, 39, 40, 39, 38, 38, 38, 38, 38, 38, 39, 38, 37, 38, 38, 38, 37, 36, 37, 35, 34, 34, 34, 32, 33, 34, 32, 34, 35, 38, 40, 38, 38, 42, 38, 38, 39, 40, 45, 50, 49, 49, 52, 57, 55, 50, 40, 41, 31, 25, 26],
    41: [41, 41, 42, 43, 44, 29, 26, 23, 20, 19, 19, 19, 19, 18, 18, 18, 19, 18, 18, 18, 18, 20, 20, 21, 22, 22, 21, 23, 28, 28, 28, 27, 29, 27, 28, 29, 27, 29, 32, 34, 35, 29, 29, 28, 26, 26, 34, 43, 121, 121, 115, 101, 103, 87, 82, 77, 122, 156, 122],
    44: [44, 44, 45, 48, 46, 45, 47, 46, 48, 50, 48, 50, 53, 51, 51, 52, 50, 52, 52, 53, 51, 51, 49, 50, 49, 50, 49, 50, 51, 48, 48, 45, 43, 39, 41, 41, 37, 39, 41, 46, 46, 46, 44, 46, 39, 39, 41, 41, 47, 53, 50, 46, 47, 50, 52, 53, 41, 40, 34, 30, 28, 25],
    48: [48, 50, 48, 51, 51, 50, 52, 51, 54, 54, 52, 53, 57, 55, 53, 53, 53, 54, 54, 54, 54, 53, 51, 49, 48, 48, 47, 51, 55, 54, 53, 57, 57, 57, 59, 60, 58, 61, 68, 68, 67, 67, 66, 69, 66, 66, 56, 57, 66, 67, 65, 59, 64, 71, 75, 85, 95, 94, 86, 77],
    49: [49, 49, 47, 50, 50, 49, 50, 50, 53, 55, 53, 55, 69, 56, 55, 55, 56, 55, 55, 57, 56, 58, 54, 57, 57, 57, 57, 60, 64, 65, 65, 69, 72, 73, 75, 79, 78, 83, 86, 86, 85, 81, 81, 83, 79, 79, 85, 94, 97, 100, 100, 103, 95, 92, 87, 91, 83, 84, 150],
    71: [71, 70, 72, 75, 75, 75, 75, 73, 72, 75, 71, 72, 72, 68, 66, 66, 67, 66, 66, 58, 57, 55, 53, 53, 50, 49, 48, 49, 53, 52, 51, 48, 48, 47, 50, 48, 42, 44, 46, 49, 48, 51, 53, 56, 50, 50, 48, 48, 56, 64, 62, 63, 65, 63, 58, 58, 55, 56, 47, 65],
    78: [78, 76, 76, 78, 76, 71, 70, 68, 64, 65, 63, 66, 65, 64, 62, 61, 62, 62, 60, 61, 59, 59, 60, 59, 59, 58, 56, 57, 60, 63, 62, 64, 62, 61, 62, 62, 60, 62, 67, 69, 68, 63, 63, 60, 45, 44, 47, 47, 54, 57, 51, 52, 62, 82, 77],
    80: [80, 268, 64, 39, 33, 31, 31, 30, 29, 29, 27, 26, 25, 25, 24, 19, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 12, 14, 15, 14, 14, 13, 12, 12, 11, 11, 12, 13, 12, 14, 15, 15, 15, 15, 17, 17, 16, 17, 18, 21, 22, 29, 55, 53, 50, 47, 48, 48, 100],
    86: [86, 82, 83, 84, 82, 79, 80, 80, 76, 67, 51, 48, 47, 46, 47, 46, 46, 47, 45, 46, 45, 43, 42, 40, 39, 39, 38, 37, 39, 36, 35, 35, 35, 33, 34, 38, 35, 37, 36, 39, 42, 37, 35, 40, 41, 41, 51, 54, 58, 58, 56, 55, 57, 74, 73, 76, 88, 87, 112],
    165: [165, 153, 146, 140, 132, 125, 126, 129, 128, 134, 132, 131, 134, 128, 129, 127, 128, 127, 132, 132, 135, 136, 132, 125, 122, 116, 111, 113, 194, 133, 121, 87, 87, 92, 94, 97, 99, 102, 111, 108, 107, 102, 101, 102, 98, 101, 101, 105, 103, 95, 91, 90, 90, 91, 86, 68, 65, 64, 62],
    223: [223, 214, 228, 69, 52, 48, 48, 47, 49, 52, 50, 51, 54, 52, 52, 51, 51, 53, 53, 52, 50, 50, 48, 48, 51, 51, 50, 52, 54, 53, 52, 49, 50, 49, 52, 52, 47, 50, 49, 50, 50, 49, 49, 51, 44, 45, 49, 50, 55, 56, 54, 95, 134, 140, 135, 134, 157, 184, 146],
    439: [439, 441, 439, 442, 439, 432, 431, 430, 416, 401, 379, 367, 366, 341, 318, 283, 223, 176, 174, 170, 174, 173, 176, 178, 174, 173, 174, 176, 176, 176, 175, 168, 158, 141, 136, 122, 89, 78, 65, 63, 60, 53, 52, 43, 31, 31, 22, 22, 23, 27, 27, 26, 26, 30, 30, 31, 34, 36, 74],
    480: [480, 481, 466, 463, 462, 461, 459, 456, 460, 470, 467, 469, 472, 468, 472, 471, 460, 450, 437, 432, 425, 419, 415, 408, 409, 405, 408, 405, 405, 413, 411, 410, 404, 399, 393, 393, 368, 368, 356, 351, 342, 321, 320, 294, 224, 215, 118, 104, 89, 62, 57, 51, 54, 55, 54, 52, 49, 47, 37, 38, 42]
}

rvirs = {
    10: [105.92, 104.34, 102.0, 99.69, 97.4, 95.14, 94.15, 92.89, 90.67, 88.47, 86.29, 84.74, 84.13, 81.98, 79.85, 77.73, 75.62, 73.53, 71.44, 70.61, 69.36, 67.28, 65.21, 63.13, 61.06, 60.54, 58.98, 56.9, 54.81, 52.97, 52.7, 50.58, 48.45, 47.08, 46.3, 44.06, 42.13, 41.56, 38.83, 37.4, 35.91, 33.52, 33.11, 30.53, 28.43, 28.19, 24.91, 23.19, 18.23, 14.15, 13.46, 11.47, 10.1, 7.62, 7.25, 5.41, 4.35, 4.19, 2.65, 1.89, 1.58, 0.81],
    12: [88.48, 87.16, 85.21, 83.27, 81.36, 79.47, 78.65, 77.6, 75.74, 73.9, 72.08, 70.78, 70.28, 68.48, 66.7, 64.93, 63.17, 61.42, 59.67, 59.05, 58.15, 56.77, 55.59, 62.19, 60.15, 59.64, 58.1, 56.05, 53.99, 52.18, 51.92, 49.83, 39.06, 33.66, 34.57, 45.55, 43.99, 43.13, 39.62, 37.89, 34.53, 27.88, 27.33, 24.31, 22.18, 21.98, 19.33, 18.4, 16.21, 13.71, 13.23, 11.97, 10.82, 7.5, 7.12, 5.56, 4.48, 4.35, 3.2, 2.49, 2.13, 1.21],
    24: [49.2, 48.46, 47.38, 46.3, 45.24, 44.19, 43.73, 43.15, 42.12, 41.09, 40.08, 39.36, 39.08, 38.08, 37.09, 36.1, 35.13, 34.15, 33.18, 32.8, 32.21, 31.25, 30.29, 29.32, 31.43, 31.8, 31.02, 29.89, 28.68, 27.66, 27.51, 26.4, 25.37, 24.78, 24.41, 23.28, 22.28, 21.98, 20.39, 19.15, 18.25, 16.54, 16.31, 14.66, 13.4, 13.28, 11.77, 11.19, 10.19, 8.71, 8.33, 7.1, 6.53, 5.51, 5.26, 4.38, 3.82, 3.74, 2.88, 2.05, 1.73, 0.97],
    30: [61.77, 60.85, 59.48, 58.14, 56.8, 55.48, 54.91, 54.17, 52.88, 51.6, 50.32, 49.42, 49.06, 47.81, 46.57, 45.33, 44.1, 42.88, 41.66, 41.18, 40.45, 39.24, 38.03, 36.82, 35.61, 35.31, 34.4, 33.18, 31.96, 30.89, 30.73, 29.5, 28.25, 27.45, 26.99, 25.93, 24.91, 24.62, 23.21, 22.59, 21.74, 20.29, 20.07, 18.42, 17.02, 16.9, 15.66, 15.13, 13.66, 11.27, 10.86, 9.41, 8.44, 7.11, 6.78, 5.54, 4.71, 4.59, 3.26, 2.42, 2.21, 1.54],
    34: [44.33, 43.67, 42.69, 41.73, 40.79, 39.81, 39.4, 38.86, 37.92, 36.95, 36.03, 35.34, 35.09, 34.17, 33.23, 32.33, 31.44, 30.56, 29.65, 29.31, 28.77, 27.92, 27.05, 26.23, 25.45, 25.26, 24.75],
    40: [41.29, 40.67, 39.76, 38.86, 37.97, 37.08, 36.7, 36.21, 35.34, 34.48, 33.64, 33.03, 32.79, 31.96, 31.14, 30.31, 29.49, 28.63, 27.8, 27.46, 26.94, 26.06, 25.17, 24.34, 23.46, 23.24, 22.6, 21.71, 20.81, 19.98, 19.85, 18.94, 18.05, 17.5, 17.19, 16.3, 15.55, 15.32, 14.25, 13.79, 13.33, 12.48, 12.32, 11.15, 10.17, 10.08, 9.0, 8.58, 7.91, 6.74, 6.38, 5.26, 4.8, 3.97, 3.8, 3.26, 2.85, 2.8, 2.24, 1.48, 1.23],
    41: [55.33, 54.51, 53.29, 52.08, 50.88, 49.7, 49.19, 48.53, 47.37, 46.22, 45.08, 44.27, 43.94, 42.73, 41.55, 40.34, 39.34, 38.13, 36.91, 36.5, 35.8, 34.67, 33.32, 31.91, 30.06, 29.59, 28.28, 25.97, 23.05, 21.99, 21.84, 20.72, 19.64, 18.94, 18.51, 17.37, 16.51, 16.26, 15.14, 14.6, 14.06, 13.59, 13.51, 12.81, 11.85, 11.72, 9.82, 8.24, 5.54, 4.48, 4.31, 3.78, 3.45, 3.13, 3.0, 2.46, 1.75, 1.53, 1.14],
    44: [38.42, 37.82, 36.96, 36.11, 35.24, 34.38, 34.01, 33.53, 32.7, 31.87, 31.04, 30.42, 30.19, 29.36, 28.57, 27.74, 26.92, 26.11, 25.31, 24.99, 24.5, 23.7, 22.89, 22.09, 21.3, 21.09, 20.5, 19.75, 19.02, 18.42, 18.35, 17.73, 17.09, 16.65, 16.37, 15.49, 14.8, 14.59, 13.66, 13.22, 12.75, 11.93, 11.79, 10.88, 9.96, 9.87, 8.78, 8.4, 7.75, 6.61, 6.32, 5.41, 4.94, 4.18, 3.95, 3.11, 2.85, 2.81, 2.07, 1.38, 1.18, 0.77],
    48: [37.88, 37.29, 36.41, 35.51, 34.64, 33.78, 33.41, 32.92, 32.07, 31.23, 30.39, 29.81, 29.57, 28.76, 27.96, 27.18, 26.42, 25.67, 24.96, 24.66, 24.23, 23.53, 22.82, 22.11, 21.4, 21.21, 20.58, 19.71, 18.82, 18.04, 17.92, 16.95, 16.06, 15.52, 15.2, 14.27, 13.53, 13.33, 12.4, 12.01, 11.54, 10.75, 10.61, 9.62, 8.91, 8.84, 7.89, 7.52, 6.78, 5.7, 5.46, 4.84, 4.4, 3.45, 3.15, 2.35, 1.89, 1.87, 1.27, 0.89],
    49: [37.85, 37.29, 36.41, 35.55, 34.72, 33.88, 33.5, 33.0, 32.12, 31.23, 30.34, 29.56, 18.01, 28.63, 27.79, 26.88, 26.03, 25.28, 24.47, 24.18, 23.73, 22.94, 22.14, 21.34, 20.52, 20.31, 19.66, 18.71, 17.71, 16.89, 16.78, 15.91, 15.04, 14.49, 14.19, 13.29, 12.63, 12.42, 11.56, 11.13, 10.7, 9.93, 9.82, 9.01, 8.2, 8.11, 7.06, 6.59, 5.91, 4.78, 4.51, 3.77, 3.62, 3.1, 2.96, 2.27, 2.0, 1.94, 1.05],
    71: [33.16, 32.66, 31.94, 31.25, 30.54, 29.83, 29.55, 29.18, 28.52, 27.93, 27.39, 27.0, 26.86, 28.14, 27.41, 26.68, 25.96, 25.24, 24.52, 24.24, 23.81, 23.1, 22.38, 20.89, 21.29, 21.11, 20.54, 19.75, 18.96, 18.23, 18.13, 17.34, 16.58, 16.08, 15.81, 15.03, 14.44, 14.25, 13.42, 13.04, 12.6, 11.64, 11.5, 10.32, 9.22, 9.15, 8.19, 7.83, 7.1, 5.73, 5.51, 4.77, 4.32, 3.74, 3.6, 2.96, 2.47, 2.38, 1.68, 0.96],
    78: [35.38, 34.86, 34.08, 33.3, 32.54, 31.78, 31.45, 31.03, 30.29, 29.56, 28.83, 28.31, 28.11, 27.39, 26.68, 25.98, 25.27, 24.57, 23.88, 23.6, 23.2, 22.5, 21.82, 21.12, 20.42, 20.23, 19.67, 18.88, 18.09, 17.39, 17.29, 16.48, 15.62, 15.12, 14.82, 14.06, 13.42, 13.24, 12.38, 11.92, 11.46, 10.79, 10.67, 10.07, 9.4, 9.32, 8.26, 7.8, 7.12, 6.35, 6.26, 5.22, 4.48, 3.22, 3.11],
    80: [68.36, 67.35, 65.84, 64.34, 62.87, 61.4, 60.77, 59.96, 58.52, 57.11, 55.7, 54.69, 54.3, 52.92, 51.54, 50.17, 48.81, 47.46, 46.11, 45.58, 44.77, 43.4, 42.12, 40.55, 38.58, 38.19, 37.01, 35.42, 33.83, 32.5, 32.31, 30.91, 29.55, 28.81, 28.37, 27.11, 25.87, 25.51, 23.73, 22.22, 21.21, 19.34, 18.93, 16.65, 14.74, 14.67, 13.51, 13.09, 12.06, 9.95, 9.36, 6.66, 4.68, 4.08, 3.98, 3.38, 2.73, 2.62, 1.19],
    86: [38.75, 38.17, 37.32, 36.47, 35.63, 34.8, 34.44, 33.98, 33.17, 32.37, 31.57, 31.0, 30.78, 29.99, 29.21, 28.44, 27.62, 26.8, 26.06, 24.52, 25.32, 24.68, 24.1, 23.62, 23.19, 23.06, 22.6, 21.76, 20.78, 19.94, 19.82, 18.85, 17.94, 17.29, 16.87, 15.83, 15.07, 14.87, 14.11, 13.73, 13.27, 12.62, 12.5, 11.29, 9.92, 9.78, 8.02, 7.55, 6.97, 6.27, 6.01, 5.13, 4.6, 3.34, 3.2, 2.46, 1.93, 1.89, 1.16],
    165: [26.0, 25.61, 25.04, 24.47, 23.91, 23.35, 23.11, 22.8, 22.26, 21.72, 21.1, 20.69, 20.52, 19.93, 19.36, 18.76, 18.19, 17.6, 17.03, 16.79, 16.46, 15.92, 15.45, 15.14, 15.12, 15.16, 15.28, 12.2, 3.89, 6.46, 7.69, 14.29, 13.61, 13.17, 12.91, 12.13, 11.56, 11.39, 10.64, 10.29, 9.88, 9.21, 9.08, 8.28, 7.58, 7.51, 6.71, 6.36, 5.76, 4.84, 4.64, 4.02, 3.69, 3.1, 2.98, 2.68, 2.3, 2.24, 1.44],
    223: [37.97, 37.4, 36.56, 35.73, 34.91, 34.1, 33.75, 33.3, 32.5, 31.71, 30.9, 30.33, 30.11, 29.35, 28.56, 27.77, 26.92, 26.12, 25.32, 25.0, 24.51, 23.7, 22.91, 22.1, 21.29, 21.09, 20.46, 19.65, 18.85, 18.19, 18.09, 17.33, 16.51, 16.01, 15.68, 14.87, 14.16, 13.97, 13.28, 12.96, 12.44, 11.73, 11.61, 10.48, 9.42, 9.31, 8.07, 7.65, 7.05, 6.37, 6.08, 3.92, 3.09, 2.58, 2.49, 1.98, 1.53, 1.41, 1.06],
    439: [21.41, 21.09, 20.62, 20.15, 19.69, 19.23, 19.03, 18.78, 18.33, 17.88, 17.44, 17.13, 17.01, 16.57, 16.14, 15.71, 15.29, 14.86, 14.44, 14.27, 14.02, 13.6, 13.17, 12.74, 12.33, 12.2, 11.89, 11.43, 10.99, 10.63, 10.59, 10.23, 10.1, 10.22, 10.34, 13.47, 12.94, 12.8, 12.11, 11.9, 11.63, 11.23, 11.19, 10.78, 10.69, 10.7, 10.99, 9.89, 10.21, 8.62, 8.38, 6.92, 6.32, 5.36, 5.07, 3.96, 2.99, 2.84, 1.37],
    480: [16.63, 16.38, 16.02, 15.65, 15.29, 14.94, 14.78, 14.59, 14.24, 13.89, 13.55, 13.3, 13.21, 12.87, 12.54, 12.2, 11.87, 11.54, 11.22, 11.09, 10.89, 10.56, 10.24, 9.91, 9.59, 9.47, 9.19, 8.9, 8.59, 8.28, 8.26, 7.9, 7.61, 7.7, 7.57, 7.21, 6.93, 6.85, 6.48, 6.33, 6.19, 5.87, 5.85, 5.53, 5.49, 5.48, 5.5, 6.25, 6.0, 5.71, 5.71, 5.16, 4.72, 4.05, 3.9, 3.13, 2.69, 2.64, 1.92, 1.27, 1.01]
}

# simulation data is stored in Prof. Christensen's home directory
name = 'h242'
path= '/home/christenc/Data/Sims/'+name+'.cosmo50PLK.3072g/'+name+'.cosmo50PLK.3072gst5HbwK1BH/snapshots_200bkgdens/'
snapshots = [name+'.cosmo50PLK.3072gst5HbwK1BH.'+snapnum for snapnum in snapnums]

for key in list(haloids.keys()):
    if len(haloids[key]) != len(snapshots):
        for i in range(len(snapshots)-len(haloids[key])):
            haloids[key].append(0)
                        
print(haloids)

# relative path should work within github repo, change if running outside of repo
savepath = f'../Data/timesteps_data/{name}.data' 

if os.path.exists(savepath):
    os.remove(savepath)
    print('Removed previous .data file')
print(f'Saving to {savepath}')

for tstep in range(len(snapshots)):
    bulk_processing(tstep, haloids, rvirs, snapshots, path, savepath)
